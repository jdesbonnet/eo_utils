<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MapSketch - app to create quick and dirty maps</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Geoman (drawing & editing) -->
  <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.1/dist/leaflet-geoman.css" />
  <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.1/dist/leaflet-geoman.min.js"></script>

  <!-- GeoTIFF support -->
  <script src="https://cdn.jsdelivr.net/npm/geotiff@2.1.4-beta.0/dist-browser/geotiff.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/georaster@1.6.0/dist/georaster.browser.bundle.min.js"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet@3.10.0/dist/georaster-layer-for-leaflet.min.js"></script>

  <!-- Import/Export helpers -->
  <script src="https://unpkg.com/tokml@0.4.0/tokml.js"></script>
  <script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>

  <!-- Screenshot (PNG export) -->
  <script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>

  <!-- Icons (AwesomeMarkers) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.awesome-markers@2.0.5/dist/leaflet.awesome-markers.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet.awesome-markers@2.0.5/dist/leaflet.awesome-markers.min.js"></script>


  <style>
    :root{
      --bg:#0b1020; --panel:#121836; --muted:#8da2fb; --text:#e8ecff; --accent:#7cf; --soft:#1b2354;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #app{display:grid;grid-template-columns:320px 1fr;grid-template-rows:1fr;gap:0;height:100%}
    aside{background:linear-gradient(180deg,var(--panel),var(--soft));padding:16px;border-right:1px solid #2b356f;overflow:auto}
    aside h1{font-size:18px;margin:0 0 12px 0}
    aside .card{background:#0e1440;border:1px solid #283176;border-radius:16px;padding:12px;margin-bottom:12px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    aside label{display:block;font-size:12px;color:#a9b6ff;margin:8px 0 4px}
    aside input, aside select, aside textarea{width:100%;background:#0a1136;color:#e9ecff;border:1px solid #3140a0;border-radius:10px;padding:8px;outline:none}
    aside textarea{min-height:64px}
    aside .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    aside .btn{display:inline-flex;align-items:center;gap:8px;background:#1c2a86;border:1px solid #3040a5;color:#e8ecff;padding:8px 10px;border-radius:12px;cursor:pointer;margin:6px 4px 0 0}
    aside .btn:hover{background:#2032a6}
    #map{height:100%;width:100%}
    .muted{color:#99a7ff;font-size:12px}
    .small{font-size:12px}
    .section-title{font-weight:600;font-size:13px;color:#b8c3ff;margin-top:6px}
    .hr{height:1px;background:#2b356f;margin:10px 0;border-radius:2px}
    .pill{display:inline-block;font-size:11px;border:1px solid #2e3ca2;border-radius:999px;padding:4px 8px;background:#101954;color:#cfe0ff}
    .toolbar{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .warn{color:#ffec9a}
  .btn.disabled{opacity:.5;filter:grayscale(0.3);cursor:not-allowed}
  .btn.disabled{opacity:.5;filter:grayscale(0.3);cursor:not-allowed}
    #map{position:relative}
    .presence{position:absolute;top:10px;right:10px;display:flex;gap:6px;z-index:5000}
    .presence .avatar{width:28px;height:28px;border-radius:999px;border:1px solid #2e3ca2;background:#0e1440;display:flex;align-items:center;justify-content:center;font-weight:700}
    .remote-cursor{display:inline-flex;align-items:center;gap:6px;background:rgba(14,20,64,.85);border:2px solid #3a49c3;border-radius:12px;padding:2px 6px;color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.4);pointer-events:none}
    .remote-cursor .dot{width:8px;height:8px;border-radius:999px;background:#fff}
  </style>
</head>
<body>
<div id="app">
  <aside>
    <h1>MapSketch</h1>
    <div class="card">
      <div class="section-title">Drawing</div>
      <div class="muted small">Use the toolbar on the map (left) to add markers, lines, and polygons. Click a feature to select it.</div>
      <div class="hr"></div>
      <div class="section-title">Selected Feature</div>
      <div class="row">
        <div>
          <label>Stroke</label>
          <input type="color" id="strokeColor" value="#ff4757" />
        </div>
        <div>
          <label>Fill</label>
          <input type="color" id="fillColor" value="#2ed573" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Opacity</label>
          <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.7" />
        </div>
        <div>
          <label>Line type</label>
          <select id="lineType">
            <option value="solid" selected>Solid</option>
            <option value="dash">Dashed</option>
            <option value="dot">Dotted</option>
          </select>
        </div>
      </div>
      <label>Marker icon</label>
      <select id="markerIcon">
        <option value="fa-location-dot,#d33">Red pin</option>
        <option value="fa-star,#f1c40f">Star (gold)</option>
        <option value="fa-flag,#3498db">Flag (blue)</option>
        <option value="fa-tree,#2ecc71">Tree (green)</option>
        <option value="fa-circle,#9b59b6">Circle (purple)</option>
      </select>
      <div class="hr"></div>
      <div class="section-title">Text</div>
      <label>Short label (shown on map)</label>
      <input id="labelText" placeholder="e.g., Gate 1" />
      <label>Popup text (longer notes, can use line breaks)</label>
      <textarea id="popupText" placeholder="Details shown on click"></textarea>
      <button class="btn" id="applyText"><i class="fa fa-tag"></i>Apply to Selected</button>
    </div>

    <div class="card">
      <div class="section-title">Freehand (Stylus) Lines</div>
      <div class="small muted">Draw a line directly with your Wacom or tablet pen.</div>
      <div class="row">
        <div>
          <label class="small">Pen-only</label>
          <select id="fhPenOnly"><option value="yes" selected>Yes</option><option value="no">No</option></select>
        </div>
        <div>
          <label class="small">Vertex spacing (m)</label>
          <input id="fhMinDist" type="number" min="0" step="1" value="5" />
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="fhEnableBtn"><i class="fa fa-pen"></i>Enable Freehand</button>
        <button class="btn" id="fhDisableBtn"><i class="fa fa-stop"></i>Disable</button>
      </div>
      <p class="small muted" style="margin-top:8px">While enabled: press pen to screen and move to draw. Lift pen to finish.</p>
    </div>
    <div class="card">
      <div class="section-title">History</div>
      <div class="toolbar">
        <button class="btn" id="undoBtn" title="Ctrl/Cmd+Z"><i class="fa fa-rotate-left"></i>Undo</button>
        <button class="btn" id="redoBtn" title="Ctrl+Shift+Z or Ctrl+Y"><i class="fa fa-rotate-right"></i>Redo</button>
      </div>
      <p class="small muted">Keyboard: Ctrl/Cmd+Z (undo), Ctrl+Shift+Z or Ctrl+Y (redo).</p>
    </div>
    <div class="card">
      <div class="section-title">Collaboration (Experimental)</div>
      <label>Your name</label>
      <input id="collabName" placeholder="e.g., Casey" />
      <label>Room ID</label>
      <input id="collabRoom" placeholder="e.g., field-team-alpha" />
      <label>Server URL (WebSocket)</label>
      <input id="collabServer" placeholder="ws://localhost:8080/ws" />
      <div class="toolbar">
        <button class="btn" id="collabConnect"><i class="fa fa-plug"></i>Connect</button>
        <button class="btn" id="collabDisconnect"><i class="fa fa-power-off"></i>Disconnect</button>
      </div>
      <div class="row">
        <div>
          <label class="small">Broadcast my view</label>
          <select id="broadcastView">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
        <div>
          <label class="small">Follow user</label>
          <select id="followUser"><option value="">(none)</option></select>
        </div>
      </div>
      <button class="btn" id="jumpToUser"><i class="fa fa-eye"></i>Jump to selected view</button>
      <p class="small muted">Multiple users can pan/zoom independently. Use the jump button to go to someone’s latest view. Names and cursors appear on the map. Feature authorship/time are stored in exports.</p>
    </div>

    <div class="card">
      <div class="section-title">Basemaps</div>
      <div class="toolbar">
        <button class="btn" id="osmBtn">OSM</button>
        <button class="btn" id="esriBtn">ESRI World Imagery</button>
      </div>
      <label class="small" style="margin-top:8px">Custom tile URL (e.g., https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png)</label>
      <input id="customTileUrl" placeholder="Enter template URL" />
      <button class="btn" id="addTileBtn"><i class="fa fa-layer-group"></i>Add Tile Layer</button>
    </div>

    <div class="card">
      <div class="section-title">GeoTIFF</div>
      <label>URL</label>
      <input id="tiffUrl" placeholder="https://example.com/rasters/elevation.tif" />
      <button class="btn" id="addTiffUrl"><i class="fa fa-image"></i>Add from URL</button>
      <div class="hr"></div>
      <label>Upload from file</label>
      <input type="file" id="tiffFile" accept=".tif,.tiff" />
    </div>

    <div class="card">
      <div class="section-title">Import</div>
      <div class="small muted">Import from GeoJSON or KML. Styles & labels are stored in properties and restored.</div>
      <input type="file" id="importFile" accept=".geojson,.json,.kml" />
    </div>

    <div class="card">
      <div class="section-title">Export</div>
      <div class="toolbar">
        <button class="btn" id="exportGeoJSON"><i class="fa fa-file-code"></i>GeoJSON</button>
        <button class="btn" id="exportKML"><i class="fa fa-file-export"></i>KML</button>
        <button class="btn" id="exportPNG"><i class="fa fa-file-image"></i>PNG</button>
      </div>
      <p class="small muted" style="margin-top:8px">Note: PNG export of third‑party tiles/rasters may require CORS; if blocked, try OSM or your own CORS‑enabled tiles.</p>
    </div>

    <div class="muted small">Tip: Double‑click the map to finish drawing a line/polygon. Use the Geoman toolbar on the map to edit or delete features.</div>
  </aside>
  <div id="map"><div id="presence" class="presence"></div></div>
</div>


  <!-- The application code -->
  <script type="module" src="mapsketch.js"></script>


</body>
</html>

